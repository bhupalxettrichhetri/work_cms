{% extends 'dashboard/adminLTE/base.html' %}
{% load static %}
{% block content %}
<nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <!-- Left navbar links -->
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
      </li>
      <li class="nav-item d-none d-sm-inline-block">
        <a href="{% url 'dashboard:dashboard' %}" class="nav-link">Dashboard</a>
      </li>
      <li class="nav-item d-none d-sm-inline-block">
        <a href="{% url 'dashboard:organization_list' %}" class="nav-link">Organizations</a>
      </li>
    </ul>

    <!-- Right navbar links -->
    <ul class="navbar-nav ml-auto">
      <li class="nav-item">
        <a class="nav-link" data-widget="fullscreen" href="#" role="button">
          <i class="fas fa-expand-arrows-alt"></i>
        </a>
      </li>
      <!-- <li class="nav-item">
        <a class="nav-link" data-widget="control-sidebar" data-controlsidebar-slide="true" href="#" role="button">
          <i class="fas fa-th-large"></i>
        </a>
      </li> -->
    </ul>
</nav>
<div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1>Devices</h1>
          </div>
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a class='btn btn-primary' href="{% url 'dashboard:device_create' pk=organization_id %}">Create</a></li></li>
            </ol>
          </div>
        </div>
      </div><!-- /.container-fluid -->
    </section>

    <!-- Main content -->
    <section class="content">

      <div class="card">
                <!-- /.card-header -->
                <div class="card-body table-responsive p-0">
                  <table class="table table-hover text-nowrap">
                    <thead>
                      <tr>
                        <th>#</th>
                        <th>Name</th>
                        <th>IP Address</th>
                        <th>vendor</th>
                        <th>Firmware</th>
                        <th class="float-right">Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for device in devices %}
                  <tr>
                      <td>
                          #
                      </td>
                      <td>
                              {{device.name}}
                          <br/>
                          <!-- <small>
                              Created 01.01.2019
                          </small> -->
                      </td>
                      <td>
                              {{device.ip_address}}
                          <br/>
                          <!-- <small>
                              Created 01.01.2019
                          </small> -->
                      </td>
                      <td >
                          {{device.vendor}}
                      </td>
                      <td >
                          {{device.firmware_version}}
                      </td>
                      <td class="project-actions text-right">
                          <a type="button" class="mb-2 btn btn-info btn-sm" href="{% url 'dashboard:device_edit' pk=device.id %}">
                              <i class="fas fa-pencil-alt">
                              </i>
                          </a>
                          <a type="button " class="mb-2 btn btn-danger btn-sm open-modal" data-toggle="modal" data-target="#exampleModalCenter" data-url="{% url 'dashboard:device_delete' pk=device.id %}"><i class="fas fa-thin fa-trash"></i></a>
                          <a type="button" href="javascript:void(0)"
                                class="mb-2 btn btn-info btn-sm"
                                data-password-id="{{ device.password.id }}"
                                onclick="openOtpModal(this)">
                                Copy Password
                              </a>
                          </a>
                          <!-- <a class="btn btn-danger btn-sm" href="#">
                              <i class="fas fa-trash">
                              </i>
                              Delete
                          </a> -->
                      </td>
                    {% endfor %}
                      <!-- <tr>
                        <td>183</td>
                        <td>John Doe</td>
                        <td>11-7-2014</td>
                        <td><span class="tag tag-success">Approved</span></td>
                        <td>Bacon ipsum dolor sit amet salami venison chicken flank fatback doner.</td>
                      </tr> -->
                    </tbody>
                  </table>
                </div>
                <!-- /.card-body -->
      </div>



      {% comment %}
      <!-- Default box -->
      <div class="card">
        <div class="card-body p-0">
          <table class="table table-striped projects">
              <thead>
                  <tr>
                      <th style="width: 1%">
                          #
                      </th>
                      <th>
                          Name
                      </th>
                      <th>
                          IP Address
                      </th>
                      <th>
                           vendor
                      </th>
                      <th>
                           Firmware
                      </th>
                      <th class="text-right">
                        Action
                      </th>
                  </tr>
              </thead>
              <tbody>
                {% for device in devices %}
                  <tr>
                      <td>
                          #
                      </td>
                      <td>
                              {{device.name}}
                          <br/>
                          <!-- <small>
                              Created 01.01.2019
                          </small> -->
                      </td>
                      <td >
                          {{device.vendor}}
                      </td>
                      <td >
                          {{device.firmware_version}}
                      </td>
                      <td class="project-actions text-right">
                          <a type="button" class="mb-2 btn btn-info btn-sm" href="{% url 'dashboard:device_edit' pk=device.id %}">
                              <i class="fas fa-pencil-alt">
                              </i>
                          </a>
                          <a type="button " class="mb-2 btn btn-danger btn-sm open-modal" data-toggle="modal" data-target="#exampleModalCenter" data-url="{% url 'dashboard:device_delete' pk=device.id %}"><i class="fas fa-thin fa-trash"></i></a>
                          <a type="button" href="javascript:void(0)"
                                class="mb-2 btn btn-info btn-sm"
                                data-password-id="{{ device.password.id }}"
                                onclick="openOtpModal(this)">
                                Copy Password
                              </a>
                          </a>
                          <!-- <a class="btn btn-danger btn-sm" href="#">
                              <i class="fas fa-trash">
                              </i>
                              Delete
                          </a> -->
                      </td>
                    {% endfor %}
              </tbody>
          </table>
        </div>
        <!-- /.card-body -->
      </div>
      <!-- /.card -->
       {% endcomment %}

    </section>
    <!-- /.content -->
  </div>
  
  <!-- Modal -->
<div class="modal fade" id="exampleModalCenter" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="post" action="" id="delete_entry">
        {% csrf_token %}
      <div class="modal-header">
        <h5 class="modal-title">Confirm Delete</h5>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>

      <div class="modal-body">
        Are you sure you want to delete this Contact?
        <input type="hidden" id="modalActionUrl">
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-danger" id="modalSubmitBtn">Delete</button>
      </div>
      </form>

    </div>
  </div>
</div>
<!-- OTP Modal -->

<div class="modal fade" id="otpModal" tabindex="-1" aria-labelledby="otpModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="otpModalLabel">Enter OTP</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">Close</button>
      </div>

      <div class="modal-body text-center">
        <div class="d-flex justify-content-center gap-2 mb-3" id="otp">
          <input type="text" maxlength="1" class="otp-input form-control text-center" id="otp-1">
          <input type="text" maxlength="1" class="otp-input form-control text-center" id="otp-2">
          <input type="text" maxlength="1" class="otp-input form-control text-center" id="otp-3">
          <input type="text" maxlength="1" class="otp-input form-control text-center" id="otp-4">
          <input type="text" maxlength="1" class="otp-input form-control text-center" id="otp-5">
          <input type="text" maxlength="1" class="otp-input form-control text-center" id="otp-6">
        </div>
        <input type="hidden" id="modal-password-id">
        <div id="modal-error-msg" class="mt-2" style="display:none;"></div>
      </div>

      <div class="modal-footer">
        <button type="button" id="verify-otp-btn" class="btn btn-success">Verify</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block javascript %}
<script>
$(document).on('click', '.open-modal', function () {
    let url = $(this).data('url');   // get the value
    $('#delete_entry').attr('action',url);   // store inside modal
});


// Initialize modal
const otpModalElement = document.getElementById('otpModal');
const otpModal = new bootstrap.Modal(otpModalElement, { keyboard: false });
const modalMessage = document.getElementById('modal-error-msg');
const verifyBtn = document.getElementById('verify-otp-btn')


const otpInputs = document.querySelectorAll('.otp-input');

document.querySelectorAll('[data-bs-dismiss="modal"]').forEach(btn => {
    btn.addEventListener('click', () => {
      otpModal.hide();
    });
    });

// const otpInputs = document.querySelectorAll('.otp-input');

  // When modal is shown
  otpModalElement.addEventListener('shown.bs.modal', () => {
    // Clear all inputs
    otpInputs.forEach(input => input.value = '');

    // Focus first input
    if (otpInputs.length > 0) {
      otpInputs[0].focus();
    }
  });

  otpInputs.forEach((input, index) => {
    // Move to next on input
    input.addEventListener('input', () => {
      if (input.value && index < otpInputs.length - 1) {
        otpInputs[index + 1].focus();
      }
    });

    // Handle Backspace â†’ move back
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Backspace' && !input.value && index > 0) {
        otpInputs[index - 1].focus();
      }
    });

    // Handle paste (multi-digit)
    input.addEventListener("paste", (e) => {
      e.preventDefault();
      const pasteData = (e.clipboardData || window.clipboardData).getData('text');
      const digits = pasteData.replace(/\D/g, '').slice(0, otpInputs.length); // only digits, max input length

      digits.split('').forEach((digit, i) => {
        if (index + i < otpInputs.length) {
          otpInputs[index + i].value = digit;
        }
      });

      // Focus last filled input
      const lastIndex = Math.min(index + digits.length, otpInputs.length - 1);
      otpInputs[lastIndex].focus();
    });
  });

function getOtpValue() {
  let otp = '';
  otpInputs.forEach(input => otp += input.value);
  return otp;
}
// Helper: Clear all OTP inputs
function clearOtpInputs() {
  otpInputs.forEach(input => input.value = '');
  otpInputs[0].focus();
}
// display none 
function hideOtpInputs() {
    $('#otp').removeClass("d-flex");
    $('#otp').addClass("d-none");
    console.log('hide')
}
function showOtpInputs() {
    $('#otp').removeClass("d-none");
    $('#otp').addClass("d-flex");
    console.log('unhide')
}
function InitializeModel(){
  showOtpInputs();
  modalMessage.style.display = 'none';
}
function showLoader(){
  document.querySelector('.preloader').removeAttribute('style');
  document.querySelector('.animation__shake').removeAttribute('style');
}
function hideLoader(){
  const loader = document.querySelector('.preloader');
  loader.style.height = '0';
  const animation = document.querySelector('.animation__shake')
  animation.style.display= "none";
}


// Open modal and request OTP
function openOtpModal(button) {
    const passwordId = button.getAttribute("data-password-id");
    document.getElementById('modal-password-id').value = passwordId;
    // alert('here')
    InitializeModel();
    showLoader();
    // const loader = document.getElementById("loader");
    // loader.classList.add("show");
    const data = new FormData();
    data.append("password_id", passwordId);

    fetch("{% url 'dashboard:ajax-post' %}", {
        method: "POST",
        body: data,
        headers: { "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value }
    })
    .then(async (response) => {
        if (!response.ok) {
            let errorData;
            try { errorData = await response.json(); } catch(e) {}
            throw new Error(errorData?.error || `Server returned status ${response.status}`);
        }
        return response.json();
    })
    .then((data) => {
        if (data.otp_required) {
            // const loader = document.getElementById("loader");
            // loader.classList.add("hidden");
            hideLoader();
            otpModal.show(); // Show the modal
        } else if (data.error) {
            alert(data.error);
        }
    })
    .catch((error) => {
        console.error(error);
        loader.classList.add("hidden");
        alert(error.message || "Failed to generate OTP.");
    });
}

// Verify OTP button click
document.getElementById('verify-otp-btn').addEventListener('click', function() {
    // const passwordId = document.getElementById('modal-password-id').value;
    // const otp = getOtpValue();
    // const errorMsg = document.getElementById('modal-error-msg');

    // if (!otp) {
    //     errorMsg.textContent = "Please enter OTP!";
    //     errorMsg.style.display = "block";
    //     return;
    // }

    const passwordId = document.getElementById('modal-password-id').value;
        const otp = getOtpValue();

        modalMessage.style.display = 'none';
        modalMessage.textContent = '';
        modalMessage.classList.remove('text-success', 'text-danger');
        // verifyBtn.disabled = true;

        if (otp.length < 6) {
            modalMessage.textContent = "Please enter the 6-digit OTP!";
            modalMessage.classList.add('text-danger');
            modalMessage.style.display = 'block';
            // verifyBtn.disabled = false;
            return;
        }

    const data = new FormData();
    data.append("otp", otp);
    data.append("password_id", passwordId);

    fetch("{% url 'dashboard:verify-otp' %}", {
        method: "POST",
        body: data,
        headers: { "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value }
    })
    .then(async (response) => {
        if (!response.ok) {
            let errorData;
            try { errorData = await response.json(); } catch(e) {}
            throw new Error(errorData?.error || `Server returned status ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
            if (data.password) {
                navigator.clipboard.writeText(data.password).then(() => {
                    hideOtpInputs();
                    modalMessage.textContent = "Password copied to clipboard!";
                    clearOtpInputs();
                    //hideOtpInputs();
                    // $("#otp").hide();
                    modalMessage.classList.add('text-success');
                    modalMessage.style.display = 'block';
                    setTimeout(() => {
                        otpModal.hide();
                        verifyBtn.disabled = false;
                    }, 500);
                });
            } else if (data.error) {
                modalMessage.textContent = data.error;
                modalMessage.classList.add('text-danger');
                modalMessage.style.display = 'block';
                verifyBtn.disabled = false;
            }
        })
    .catch(error => {
            console.error(error);
            modalMessage.textContent = error.message || "OTP verification failed.";
            clearOtpInputs();
            modalMessage.classList.add('text-danger');
            modalMessage.style.display = 'block';
            verifyBtn.disabled = false;
        });
});

</script>

  
{% endblock %}